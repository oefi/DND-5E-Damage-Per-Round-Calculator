<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D&D 5e DPR Simulator (4-Round, 2024 Features)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #111827;
            --text: #ecf0f1;
            --subtle-text: #9ca3af;
            --panel: #1f2933;
            --panel-soft: #111827;
            --panel-border: #374151;
            --accent: #f1c40f;
            --danger: #e74c3c;
            --primary: #3498db;
            --success: #27ae60;
            --muted: #95a5a6;
            --log-bg: #020617;
            --log-header: #020617;
            --attack-row-bg: #111827;
            --input-bg: #020617;
            
            /* Unified Color Palette */
            --c-adv: #27ae60;      /* Green */
            --c-super: #16a085;    /* Teal */
            --c-bless: #d35400;    /* Burnt Orange */
            --c-graze: #8b5cf6;    /* Purple */
            --c-gwf: #4b5563;      /* Grey/Slate */
        }

        body.light {
            --bg: #ecf0f1;
            --text: #333333;
            --subtle-text: #7f8c8d;
            --panel: #ffffff;
            --panel-soft: #f9f9f9;
            --panel-border: #e0e0e0;
            --accent: #f1c40f;
            --danger: #e74c3c;
            --primary: #3498db;
            --success: #27ae60;
            --muted: #95a5a6;
            --log-bg: #2c3e50;
            --log-header: #1a252f;
            --attack-row-bg: #f9f9f9;
            --input-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        .header-bar {
            background: var(--panel); padding: 10px 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.25);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 20; flex-shrink: 0; height: 50px;
            border-bottom: 1px solid var(--panel-border);
        }
        h1 { margin: 0; color: var(--text); font-size: 1.4em; display: flex; align-items: center; gap: 10px; }
        .subtitle { font-size: 0.6em; color: var(--subtle-text); border: 1px solid var(--panel-border); padding: 2px 8px; border-radius: 12px; text-transform: uppercase; }
        .header-controls { display: flex; gap: 10px; }
        
        .btn-circle { 
            border: none; width: 32px; height: 32px; border-radius: 50%; 
            font-weight: 900; font-size:1.1em; cursor: pointer; color: #2c3e50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: transform 0.1s;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-circle:hover { transform: scale(1.1); }
        .btn-help { background: var(--accent); }
        .btn-reset { background: var(--danger); color: white; }
        .btn-theme { background: var(--primary); color: white; }

        /* --- Layout --- */
        .main-container {
            display: flex; flex-direction: column;
            padding: 20px; gap: 20px;
            flex-grow: 1; overflow: auto;
            max-width: 1400px; margin: 0 auto; width: 100%;
            box-sizing: border-box;
        }

        .dashboard-panel {
            display: grid; grid-template-columns: 1fr 4fr; gap: 20px;
            align-items: stretch;
        }

        .dash-left { display: flex; flex-direction: column; gap: 15px; }
        .dash-right { display: flex; flex-direction: column; }

        /* --- Metrics & Chart --- */
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .metric-box { 
            background: var(--panel); padding: 10px; border-radius: 8px; text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.25); border: 1px solid var(--panel-border);
        }
        .ac-box { border: 2px solid var(--danger) !important; }
        input.ac-input {
            font-size: 1.5em; border: none; outline: none;
            background: transparent; text-align: center; color: var(--danger); font-weight: bold; width: 100%;
        }
        .metric-val { font-size: 1.4em; font-weight: 800; color: var(--text); }
        .metric-lbl { font-size: 0.65em; text-transform: uppercase; color: var(--subtle-text); font-weight: bold; }

        .chart-box {
            background: var(--panel); padding: 10px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.25); flex-grow: 1; position: relative;
            border: 1px solid var(--panel-border);
            min-height: 140px;
        }

        /* --- Log/Live Calc --- */
        .log-box {
            background: var(--log-bg); color: #ecf0f1; border-radius: 8px;
            font-family: 'Consolas', monospace; font-size: 0.85em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); display: flex; flex-direction: column;
        }
        .log-header {
            background: var(--log-header); padding: 8px 12px; font-weight: bold; border-bottom: 1px solid #34495e;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .grand-total-header { font-size: 0.9em; color: #2ecc71; font-weight: bold; white-space: nowrap; }
        .log-content { padding: 10px; }

        .round-columns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .round-col {
            background: #111827; border-radius: 6px; padding: 8px;
            border: 1px solid #1f2937; display: flex; flex-direction: column;
        }
        .round-col-header {
            font-weight: bold; font-size: 0.85em; margin-bottom: 6px;
            color: #f1c40f; text-transform: uppercase;
        }
        .round-sum {
            margin-top: 6px; padding-top: 4px; border-top: 1px dashed #4b5563;
            font-weight: bold; font-size: 0.85em; color: #2ecc71;
        }

        /* --- Math breakdown colors --- */
        .c-blue { color: #5dade2; font-weight: bold; }
        .c-orange { color: #f5b041; font-weight: bold; }
        .c-purple { color: #af7ac5; font-weight: bold; }
        .c-grey { color: #bdc3c7; }
        .c-green { color: #2ecc71; font-weight: bold; }
        .op { color: #7f8c8d; margin: 0 4px; }

        /* --- Rounds & Inputs --- */
        .input-panel {
            flex-grow: 1; padding-right: 5px; 
            display: flex; flex-direction: column; gap: 15px;
        }

        .round-card { 
            background: var(--panel); border-radius: 10px; padding: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.25); border: 1px solid var(--panel-border); 
            margin-bottom: 15px; 
        }
        .round-top { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #4b5563; 
        }
        .round-title {
            font-weight:bold; font-size: 1.2em; color: #f1c40f; text-align:center; flex-shrink: 0;
        }
        .round-dice-row { display:flex; flex-direction:column; gap:4px; }
        .dice-label { font-size:0.75em; font-weight:bold; color:#9ca3af; text-transform:uppercase; }
        .dice-row { display:flex; align-items:center; gap:6px; }
        
        /* Dice Shapes */
        .die-source {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 0.8em; cursor: grab; user-select: none;
        }
        .d4 { background-color: #e74c3c; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); padding-top:4px; }
        .d6 { background-color: #3498db; border-radius: 4px; }
        .d8 { background-color: #9b59b6; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .d10 { background-color: #2ecc71; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }
        .d12 { background-color: #f39c12; clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); }

        /* Global Toggles Container */
        .global-group {
            background: rgba(15,23,42,0.6);
            border-radius: 8px;
            border: 1px solid #4b5563;
            padding: 8px 12px;
            display:flex;
            flex-direction:row;
            align-items: center;
            gap:10px;
        }
        .global-group-title {
            font-size:0.75em; text-transform:uppercase; color:#9ca3af; font-weight: bold;
            margin-right: 5px; border-right: 1px solid #4b5563; padding-right: 10px;
        }
        .global-btn-row { display: flex; gap: 8px; }

        /* Attack Row Layout */
        .attack-row {
            display: grid;
            grid-template-columns: 80px 100px 110px 100px 1fr 110px 80px 180px 150px;
            align-items: center; gap: 12px;
            background: var(--attack-row-bg); padding: 15px; margin-bottom: 10px;
            border-radius: 8px; border: 1px dashed #4b5563;
        }

        .dice-tray { 
            display: flex; flex-wrap: wrap; gap: 6px; min-height: 44px; 
            background: var(--input-bg); padding: 6px; border-radius: 4px; 
            border: 1px solid #4b5563; align-items: center; 
        }
        .mini-die { width: 28px; height: 28px; font-size: 0.7em; display: flex; justify-content: center; align-items: center; color: white; cursor: pointer; }
        
        input.std-input { width: 100%; border: 1px solid #4b5563; border-radius: 4px; padding: 8px; text-align: center; font-weight: bold; background: var(--input-bg); color: var(--text); }
        
        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }

        /* Color Coded Buttons */
        .btn-toggle { width: 100%; height: 40px; font-size: 0.75em; text-transform: uppercase; background: #6b7280; color: white; opacity: 0.6; }
        
        .btn-toggle.adv.active, .btn-glb-adv { background: var(--c-adv); opacity: 1; }
        .btn-toggle.superadv.active, .btn-glb-super { background: var(--c-super); opacity: 1; }
        .btn-toggle.bless.active, .btn-glb-bless { background: var(--c-bless); opacity: 1; }
        
        .btn-flag { width: 100%; height: 18px; font-size: 0.65em; text-transform: uppercase; background: #4b5563; color:white; margin-bottom:4px; opacity: 0.5; }
        .btn-flag.active { opacity: 1; }
        
        .flag-graze.active, .btn-glb-graze { background: var(--c-graze); }
        .flag-gwf.active, .btn-glb-gwf { background: var(--c-gwf); }

        /* Helper for Global Buttons */
        .btn-glb { height: 32px; padding: 0 12px; font-size: 0.7em; text-transform: uppercase; color: white; border: 1px solid rgba(255,255,255,0.1); }

        .btn-action { height: 40px; font-size: 0.8em; color: white; text-transform: uppercase; }
        .btn-copy { background: #3498db; width: 100%; }
        .btn-del { background: #e74c3c; width: 100%; }

        .btn-add-round { background: #95a5a6; color: white; padding: 15px; width: 100%; font-weight: bold; margin-top: 10px; }
        .btn-txt-red { background: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 4px 8px; font-size: 0.75em; text-transform: uppercase; }

        /* Modal & Manual Styling */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: var(--panel); padding: 24px; border-radius: 12px; max-width: 650px; color: var(--text); border: 1px solid var(--panel-border); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .manual-section { margin-bottom: 12px; border-bottom: 1px solid var(--panel-border); padding-bottom: 10px; }
        .manual-title { font-weight:bold; margin-bottom:8px; color: var(--accent); }
        .manual-list { margin: 0; padding-left: 18px; font-size:0.9em; line-height: 1.6; }
        
        .help-badge { 
            display: inline-block; padding: 2px 6px; border-radius: 3px; 
            font-size: 0.75em; font-weight: bold; text-transform: uppercase; color: white;
            vertical-align: middle; margin: 0 2px;
        }
        .hb-adv { background: var(--c-adv); }
        .hb-super { background: var(--c-super); }
        .hb-bless { background: var(--c-bless); }
        .hb-graze { background: var(--c-graze); }
        .hb-gwf { background: var(--c-gwf); }
        .hb-del { background: var(--danger); }
        .hb-copy { background: var(--primary); }

        #tt { position: fixed; background: rgba(0,0,0,0.95); color: white; padding: 8px 12px; border-radius: 4px; pointer-events: none; display: none; z-index: 3000; font-size: 0.85em; white-space: pre-line; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>

<div id="tt"></div>

<div id="help-modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-box">
        <h2 style="margin-top:0; border-bottom:1px solid #4b5563; padding-bottom:10px;">üß≠ Simulator Guide</h2>

        <div class="manual-section">
            <div class="manual-title">1. Modifiers & Toggles</div>
            <ul class="manual-list">
                <li><span class="help-badge hb-adv">Advantage</span> Rolls 2d20, keeps highest.</li>
                <li><span class="help-badge hb-super">Super Adv</span> Rolls 3d20, keeps highest (Elven Accuracy).</li>
                <li><span class="help-badge hb-bless">Bless</span> Adds +2.5 average to Hit roll.</li>
                <li><span class="help-badge hb-graze">Graze</span> (2024 Rule) On a miss, deal flat damage equal to MOD.</li>
                <li><span class="help-badge hb-gwf">GWF</span> (2024 Rule) Treat any damage roll of 1 or 2 as a 3.</li>
            </ul>
        </div>

        <div class="manual-section">
            <div class="manual-title">2. Managing Attacks</div>
            <ul class="manual-list">
                <li><b>Drag & Drop:</b> Drag dice (d4-d12) from the Round Header into any <span style="background:#020617; border:1px solid #4b5563; color:white; padding:0 4px; font-size:0.8em;">Dice Tray</span>.</li>
                <li><span class="help-badge hb-copy">Duplicate Attack</span> Clones the row (great for Extra Attack).</li>
                <li><span class="help-badge hb-del">Delete Attack</span> Removes the row.</li>
                <li><b>Global Buttons:</b> Use the top-right buttons in Round 1 to toggle effects for <b>ALL</b> attacks.</li>
            </ul>
        </div>

        <div class="manual-section" style="border:none;">
            <div class="manual-title">3. Logic Notes</div>
            <ul class="manual-list">
                <li><b>Live Calc:</b> The "Live Calculations" log shows the math for every single round.</li>
                <li><b>4-Round Sim:</b> If you only configure Round 1, rounds 2-4 automatically copy it.</li>
            </ul>
        </div>

        <div style="text-align:right;">
            <button onclick="document.getElementById('help-modal').style.display='none'" style="background:#2c3e50; color:white; padding:8px 16px; border-radius:6px;">Close Guide</button>
        </div>
    </div>
</div>

<div class="header-bar">
    <h1>‚öîÔ∏è D&D 5e DPR <span class="subtitle">4-Round Sim</span></h1>
    <div class="header-controls">
        <button class="btn-circle btn-reset" onclick="resetToDefaults()" data-tip="Reset everything to a simple default setup.">‚ü≥</button>
        <button class="btn-circle btn-theme" id="theme-toggle" onclick="toggleTheme()" data-tip="Switch between dark and light layout.">‚òæ</button>
        <button class="btn-circle btn-help" onclick="document.getElementById('help-modal').style.display='flex'" data-tip="Open the quick guide.">?</button>
    </div>
</div>

<div class="main-container">
    
    <div class="dashboard-panel">
        <div class="dash-left">
            <div class="metrics-grid">
                <div class="metric-box ac-box" data-tip="Target Armor Class of the enemy.\nScroll the mouse wheel here to adjust.">
                    <div class="metric-lbl">Target AC</div>
                    <input type="number" id="target-ac" class="ac-input" value="15" oninput="calc()">
                </div>
                <div class="metric-box" data-tip="Critical hit range.\n20 = crits only on natural 20.\n19‚Äì20 or 18‚Äì20 = expanded crit range.">
                    <div class="metric-lbl">Crit Range</div>
                    <select id="crit-range" class="std-input" onchange="calc()">
                        <option value="20">20</option>
                        <option value="19">19‚Äì20</option>
                        <option value="18">18‚Äì20</option>
                    </select>
                </div>
                <div class="metric-box" data-tip="Total expected damage across all 4 rounds.">
                    <div class="metric-val" id="total-dmg">0</div>
                    <div class="metric-lbl">Total (4 Rnds)</div>
                </div>
                <div class="metric-box" data-tip="Average damage per round (Total √∑ 4).">
                    <div class="metric-val" id="dpr" style="color:#3498db;">0</div>
                    <div class="metric-lbl">Avg DPR</div>
                </div>
            </div>
            <div class="chart-box" data-tip="Cumulative damage projection across the 4 rounds.">
                <canvas id="dmgChart"></canvas>
            </div>
        </div>

        <div class="dash-right">
            <div class="log-box">
                <div class="log-header" data-tip="Live breakdown of expected damage for each round.">
                    <span>Live Calculations</span>
                    <span id="grand-total-bar" class="grand-total-header">Total: 0</span>
                </div>
                <div id="log-content" class="log-content"></div>
            </div>
        </div>
    </div>

    <div class="input-panel">
        <div id="rounds-container"></div>
        <div id="footer-actions"></div>
    </div>
</div>

<script>
    let rounds = [];
    let myChart = null;

    const AVGS = { 'd4': 2.5, 'd6': 3.5, 'd8': 4.5, 'd10': 5.5, 'd12': 6.5 };
    
    /* 2024 GWF Rules: Treat a roll of 1 or 2 as a 3.
       d4: (3+3+3+4)/4 = 3.25
       d6: (3+3+3+4+5+6)/6 = 4.0
       d8: (3*3 + 4+5+6+7+8)/8 = 39/8 = 4.875
       d10: (3*3 + 4..10)/10 = 58/10 = 5.8
       d12: (3*3 + 4..12)/12 = 81/12 = 6.75
    */
    const AVGS_GWF = { 'd4': 3.25, 'd6': 4.0, 'd8': 4.875, 'd10': 5.8, 'd12': 6.75 };
    
    const D_ORDER = ['d4','d6','d8','d10','d12'];
    const BOUNDS = { ac: { min: 0, max: 50 }, toHit: { min: -10, max: 50 }, mod: { min: -10, max: 100 } };
    function clamp(v,min,max){return Math.min(Math.max(v,min),max);}

    function init() {
        rounds = [{
            attacks:[{
                toHit:8,
                dice:['d8'],
                flat:5,
                adv:false,
                superAdv:false,
                bless:false,
                graze:false,
                gwf:false
            }]
        }];
        document.getElementById('target-ac').value = 15;
        document.getElementById('crit-range').value = 20;
        startChart();
        render();
        calc();
    }

    function resetToDefaults() { if(confirm("Reset all combat data to defaults?")) init(); }

    function effectiveRoundConfig(index) {
        const lastIdx = rounds.length - 1;
        const baseIndex = index < rounds.length ? index : lastIdx;
        return rounds[baseIndex];
    }

    function calc() {
        const ac = clamp(parseInt(document.getElementById('target-ac').value)||15, BOUNDS.ac.min, BOUNDS.ac.max);
        const critMin = parseInt(document.getElementById('crit-range').value) || 20;
        let total = 0; 
        let chartData = [0];
        let html = '<div class="round-columns">';

        let effConfigs = [];
        for (let r = 0; r < 4; r++) {
            effConfigs[r] = JSON.parse(JSON.stringify(effectiveRoundConfig(r)));
        }

        for(let r=0; r<4; r++) {
            const rnd = effConfigs[r];
            let rDmg = 0;
            let isDuplicate = false;
            if (r > 0 && JSON.stringify(effConfigs[r]) === JSON.stringify(effConfigs[r-1])) {
                isDuplicate = true;
            }

            html += `<div class="round-col">`;
            html += `<div class="round-col-header">Round ${r+1}${isDuplicate ? ` (same as R${r})` : ''}</div>`;

            if (!isDuplicate) {
                rnd.attacks.forEach((atk, i) => {
                    let dAvg = atk.dice.reduce((sum,d) => sum + (atk.gwf ? AVGS_GWF[d] : AVGS[d]), 0);
                    let totalAvg = dAvg + atk.flat;

                    let bonus = atk.toHit + (atk.bless ? 2.5 : 0);

                    // Chance to hit (including crit range)
                    let pSingle = clamp((21 - (ac - bonus)) / 20, 0.05, 0.95);
                    
                    // Chance to Crit specifically
                    let critBase = (21 - critMin) / 20;
                    critBase = clamp(critBase, 0, 1);

                    let p, crit;
                    if (atk.superAdv) {
                        p = 1 - Math.pow(1-pSingle, 3);
                        crit = 1 - Math.pow(1-critBase, 3);
                    } else if (atk.adv) {
                        p = 1 - Math.pow(1-pSingle, 2);
                        crit = 1 - Math.pow(1-critBase, 2);
                    } else {
                        p = pSingle;
                        crit = critBase;
                    }

                    // p includes the crit chance within it.
                    // pMiss is simply 1 - Total Hit Chance.
                    let pMiss = 1 - p;
                    let grazeFlat = atk.graze ? atk.flat : 0;

                    /* DPR Formula: 
                       (HitChance * NormalDamage) + (CritChance * DiceDamage) + (MissChance * GrazeDamage)
                       Note: "NormalDamage" includes Dice+Mod. 
                       "CritChance * DiceDamage" adds the *extra* dice from the crit.
                    */
                    let eVal = (p * totalAvg) + (crit * dAvg) + (pMiss * grazeFlat);
                    rDmg += eVal;

                    html += `<div style="margin-bottom:8px; padding-bottom:5px; border-bottom:1px dashed #444;">
                        <div style="font-weight:bold;">#${i+1}: +${atk.toHit} vs AC ${ac}</div>
                        <div style="font-size:0.9em;">
                            <span class="c-blue">${(p*100).toFixed(0)}%</span> <span class="op">√ó</span> 
                            <span class="c-orange">${totalAvg.toFixed(2)}</span> <span class="op">+</span> 
                            <span class="c-purple">${(crit*100).toFixed(1)}%</span> <span class="op">√ó</span> 
                            <span class="c-grey">${dAvg.toFixed(2)}</span> <span class="op">+</span>
                            <span class="c-grey">${(pMiss*100).toFixed(0)}%</span> <span class="op">√ó</span>
                            <span class="c-orange">${grazeFlat.toFixed(2)}</span>
                            <span class="op">=</span> 
                            <span class="c-green">${eVal.toFixed(2)}</span>
                        </div>
                    </div>`;
                });
            } else {
                rnd.attacks.forEach((atk) => {
                    let dAvg = atk.dice.reduce((sum,d) => sum + (atk.gwf ? AVGS_GWF[d] : AVGS[d]), 0);
                    let totalAvg = dAvg + atk.flat;
                    let bonus = atk.toHit + (atk.bless ? 2.5 : 0);

                    let pSingle = clamp((21 - (ac - bonus)) / 20, 0.05, 0.95);
                    let critBase = (21 - critMin) / 20;
                    critBase = clamp(critBase, 0, 1);

                    let p, crit;
                    if (atk.superAdv) {
                        p = 1 - Math.pow(1-pSingle, 3);
                        crit = 1 - Math.pow(1-critBase, 3);
                    } else if (atk.adv) {
                        p = 1 - Math.pow(1-pSingle, 2);
                        crit = 1 - Math.pow(1-critBase, 2);
                    } else {
                        p = pSingle;
                        crit = critBase;
                    }

                    let pMiss = 1 - p;
                    let grazeFlat = atk.graze ? atk.flat : 0;

                    let eVal = (p * totalAvg) + (crit * dAvg) + (pMiss * grazeFlat);
                    rDmg += eVal;
                });
                html += `<div style="font-size:0.85em; color:#9ca3af; margin-bottom:4px;">Same as Round ${r}.</div>`;
            }

            total += rDmg; 
            chartData.push(total);
            html += `<div class="round-sum">Round Total: ${rDmg.toFixed(2)}</div>`;
            html += `</div>`;
        }

        html += '</div>';
        document.getElementById('log-content').innerHTML = html;
        document.getElementById('grand-total-bar').innerText = "Total: " + total.toFixed(1);
        document.getElementById('total-dmg').innerText = total.toFixed(0);
        document.getElementById('dpr').innerText = (total/4).toFixed(1);
        if(myChart) { myChart.data.datasets[0].data = chartData; myChart.update(); }
    }

    function render() {
        const c = document.getElementById('rounds-container');
        c.innerHTML = '';
        rounds.forEach((rnd, rI) => {
            let h = `<div class="round-card">
                <div class="round-top">
                    <div class="round-dice-row">
                        <span class="dice-label">Drag Dice:</span>
                        <div class="dice-row">
                            <div class="die-source d4" draggable="true" ondragstart="drag(event)" data-type="d4" data-tip="d4 damage die">d4</div>
                            <div class="die-source d6" draggable="true" ondragstart="drag(event)" data-type="d6" data-tip="d6 damage die">d6</div>
                            <div class="die-source d8" draggable="true" ondragstart="drag(event)" data-type="d8" data-tip="d8 damage die">d8</div>
                            <div class="die-source d10" draggable="true" ondragstart="drag(event)" data-type="d10" data-tip="d10 damage die">d10</div>
                            <div class="die-source d12" draggable="true" ondragstart="drag(event)" data-type="d12" data-tip="d12 damage die">d12</div>
                        </div>
                    </div>
                    
                    <div class="round-title">Round ${rI+1}</div>
                    
                    <div>`;

            if (rI === 0) {
                h += `
                        <div class="global-group">
                            <div class="global-group-title">Global Toggles</div>
                            <div class="global-btn-row">
                                <button class="btn-glb btn-glb-adv" onclick="toggleAll('adv')" data-tip="Toggle Advantage (Green) for ALL attacks.">Adv</button>
                                <button class="btn-glb btn-glb-super" onclick="toggleAll('superAdv')" data-tip="Toggle Super Advantage (Teal) for ALL attacks.">Sup</button>
                                <button class="btn-glb btn-glb-bless" onclick="toggleAll('bless')" data-tip="Toggle Bless (Orange) for ALL attacks.">Bless</button>
                                <button class="btn-glb btn-glb-graze" onclick="toggleAll('graze')" data-tip="Toggle Graze (Purple) for ALL attacks.">Graze</button>
                                <button class="btn-glb btn-glb-gwf" onclick="toggleAll('gwf')" data-tip="Toggle GWF (Grey) for ALL attacks.">GWF</button>
                            </div>
                        </div>`;
            } else {
                 h += `<button class="btn-txt-red" onclick="delRnd(${rI})" data-tip="Remove this round.">Remove Round</button>`;
            }

            h += `</div></div>`;

            rnd.attacks.forEach((atk, aI) => {
                let dHtml = '';
                atk.dice.forEach((d,dI) => { 
                    dHtml += `<div class="mini-die ${d}" onclick="delDie(${rI},${aI},${dI})" onwheel="scrollDie(event,${rI},${aI},${dI})" data-tip="Click to remove.\nScroll to change type.">${d}</div>`; 
                });
                
                h += `<div class="attack-row" ondrop="drop(event,${rI},${aI})" ondragover="allow(event)" data-tip="Configure Attack #${aI+1}">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span style="font-size:0.6em; font-weight:bold; color:#9ca3af;">HIT</span>
                        <input type="number" class="std-input" value="${atk.toHit}" oninput="setV(${rI},${aI},'toHit',this.value)" onwheel="scrollVal(event,this,${rI},${aI},'toHit')">
                    </div>
                    <button class="btn-toggle adv ${atk.adv?'active':''}" onclick="tog(${rI},${aI},'adv')" data-tip="Advantage">Advantage</button>
                    <button class="btn-toggle superadv ${atk.superAdv?'active':''}" onclick="tog(${rI},${aI},'superAdv')" data-tip="Super Advantage (3d20)">Super Adv</button>
                    <button class="btn-toggle bless ${atk.bless?'active':''}" onclick="tog(${rI},${aI},'bless')" data-tip="Bless (+2.5 to hit)">Bless</button>
                    <div class="dice-tray" data-tip="Drag dice here.">${dHtml || '<span style="color:#6b7280; font-size:0.7em;">Drop Dice Here</span>'}</div>
                    <div style="display:flex; flex-direction:column; align-items:stretch; gap:4px;">
                        <button class="btn-flag flag-graze ${atk.graze?'active':''}" onclick="tog(${rI},${aI},'graze')" data-tip="Graze: Deal MOD damage on miss.">Graze</button>
                        <button class="btn-flag flag-gwf ${atk.gwf?'active':''}" onclick="tog(${rI},${aI},'gwf')" data-tip="GWF: Treat damage rolls of 1 or 2 as 3.">GWF</button>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span style="font-size:0.6em; font-weight:bold; color:#9ca3af;">MOD</span>
                        <input type="number" class="std-input" value="${atk.flat}" oninput="setV(${rI},${aI},'flat',this.value)" onwheel="scrollVal(event,this,${rI},${aI},'flat')">
                    </div>
                    <button class="btn-action btn-copy" onclick="dup(${rI},${aI})" data-tip="Duplicate this attack">Duplicate Attack</button>
                    <button class="btn-action btn-del" onclick="delAtk(${rI},${aI})" data-tip="Delete this attack">Delete Attack</button>
                </div>`;
            });
            h += `</div>`;
            c.innerHTML += h;
        });
        const f = document.getElementById('footer-actions');
        if (rounds.length < 4) f.innerHTML = `<button class="btn-add-round" onclick="addRound()" data-tip="Add a new round configuration (up to 4).">+ Add New Round Config</button>`;
        else f.innerHTML = `<div style="text-align:center; color:#95a5a6; font-weight:bold; padding:15px;">Max Rounds (4) Configured</div>`;
    }

    function setV(r,a,k,v) { 
        let val = parseInt(v)||0; 
        if(k==='toHit') val=clamp(val,BOUNDS.toHit.min,BOUNDS.toHit.max);
        if(k==='flat') val=clamp(val,BOUNDS.mod.min,BOUNDS.mod.max);
        rounds[r].attacks[a][k]=val; calc(); 
    }
    function scrollVal(e,el,r,a,k) { e.preventDefault(); let v=parseInt(el.value)||0; v+=(e.deltaY<0?1:-1); el.value=v; setV(r,a,k,v); }
    function scrollDie(e,r,a,d) { e.preventDefault(); e.stopPropagation(); let idx=D_ORDER.indexOf(rounds[r].attacks[a].dice[d]); idx=clamp(idx+(e.deltaY<0?1:-1),0,D_ORDER.length-1); rounds[r].attacks[a].dice[d]=D_ORDER[idx]; render(); calc(); }
    function tog(r,a,k) { 
        if (k === 'superAdv' && !rounds[r].attacks[a][k]) {
            rounds[r].attacks[a].adv = false;
        }
        if (k === 'adv' && !rounds[r].attacks[a][k]) {
            rounds[r].attacks[a].superAdv = false;
        }
        rounds[r].attacks[a][k]=!rounds[r].attacks[a][k]; 
        render(); 
        calc(); 
    }
    function dup(r,a) { rounds[r].attacks.splice(a+1,0, JSON.parse(JSON.stringify(rounds[r].attacks[a]))); render(); calc(); }
    function delAtk(r,a) { 
        rounds[r].attacks.splice(a,1); 
        if(rounds[r].attacks.length===0) 
            rounds[r].attacks.push({toHit:8, dice:['d8'], flat:5, adv:false, superAdv:false, bless:false, graze:false, gwf:false}); 
        render(); calc(); 
    }
    function delDie(r,a,d) { rounds[r].attacks[a].dice.splice(d,1); render(); calc(); }
    function addRound() { if(rounds.length>=4)return; rounds.push(JSON.parse(JSON.stringify(rounds[rounds.length-1]))); render(); calc(); }
    function delRnd(r) { rounds.splice(r,1); render(); calc(); }
    function drag(e){e.dataTransfer.setData("text",e.target.dataset.type);}
    function allow(e){e.preventDefault();}
    function drop(e,r,a){ e.preventDefault(); const t=e.dataTransfer.getData("text"); if(AVGS[t]){rounds[r].attacks[a].dice.push(t); render(); calc();} }

    function toggleAll(type) {
        let anyOff = false;
        rounds.forEach(r => r.attacks.forEach(a => { if(!a[type]) anyOff = true; }));
        const newState = anyOff ? true : false;

        rounds.forEach(r => r.attacks.forEach(a => { 
            if (type === 'adv' && newState) {
                a.superAdv = false;
            }
            if (type === 'superAdv' && newState) {
                a.adv = false;
            }
            a[type] = newState; 
        }));
        render();
        calc();
    }

    function startChart() {
        const ctx=document.getElementById('dmgChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { 
            type:'line', 
            data:{
                labels:['Start','R1','R2','R3','R4'], 
                datasets:[{
                    data:[0], 
                    borderColor:'#2c3e50', 
                    backgroundColor:'rgba(52, 152, 219, 0.2)', 
                    fill:true, 
                    tension:0.3
                }]
            }, 
            options:{
                responsive:true, 
                maintainAspectRatio:false, 
                plugins:{legend:{display:false}}, 
                scales:{y:{beginAtZero:true}}
            }
        });
    }

    function toggleTheme() {
        document.body.classList.toggle('light');
        const btn = document.getElementById('theme-toggle');
        if (document.body.classList.contains('light')) {
            btn.textContent = '‚òÄ';
            btn.setAttribute('data-tip', 'Switch back to dark layout.');
        } else {
            btn.textContent = '‚òæ';
            btn.setAttribute('data-tip', 'Switch to light layout.');
        }
    }

    const tt = document.getElementById('tt');
    document.addEventListener('mousemove', e => {
        const t = e.target.closest('[data-tip]');
        if(t) { 
            tt.innerText = t.dataset.tip.replace(/\\n/g, '\n'); 
            tt.style.display='block';
            let left = e.clientX + 12; 
            if(left+260 > window.innerWidth) left = e.clientX-270;
            tt.style.left=left+'px'; 
            tt.style.top=(e.clientY+12)+'px';
        } else tt.style.display='none';
    });
    document.addEventListener('wheel', () => { tt.style.display='none'; });

    document.getElementById('target-ac').addEventListener('wheel', e => { 
        e.preventDefault(); 
        let v=parseInt(e.target.value)||15; 
        v+=(e.deltaY<0?1:-1); 
        e.target.value=clamp(v,BOUNDS.ac.min,BOUNDS.ac.max); 
        calc(); 
    });

    init();
</script>
</body>
</html>
